<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
	<head>
		<meta charset="utf-8">
		<title>Main</title>
		<script th:src="@{js/jquery-3.5.0.min.js}" src="../static/js/jquery-3.5.0.min.js" type="text/javascript">
		</script>
		<script th:src="@{js/echarts.min.js}" src="../static/js/echarts.min.js" type="text/javascript">
		</script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

		<link rel="stylesheet" th:href="@{js/font-awesome/4.5.0/css/font-awesome.min.css}" />
		<link rel="stylesheet" th:href="@{js/css/customStyles.css}" />

		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
		<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
		<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css' />
	</head>

	<body>
	<div id="wrapper">
		<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
			<a class="navbar-brand mb-0 h1" style="font-size: x-large" href="#"><i class="fa fa-bar-chart" aria-hidden="true"><b> Stocks</b></i></a>
			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>

			<div class="collapse navbar-collapse" id="navbarSupportedContent" style="font-size: larger">

				<ul class="navbar-nav mr-auto">
					<li class="nav-item active">
						<a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
					</li>
					<li class="nav-item">
						<a class="nav-link" th:href="@{/tables}">Table</a>
					</li>
				</ul>
				<ul class="navbar-nav navbar-right">
					<li class="nav-item dropdown">
						<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fa fa-user fa-fw"></i>
							<b> User name</b>
						</a>
						<div class="dropdown-menu" aria-labelledby="navbarDropdown">
							<a class="dropdown-item" href="#">
								<i class="fa fa-user fa-fw"></i> Profile
							</a>
							<a class="dropdown-item" href="#">
								<i class="fa fa-gear fa-fw"></i> Settings
							</a>
							<div class="dropdown-divider"></div>
							<a class="dropdown-item" th:href="@{/}">
								<i class="fa fa-sign-out fa-fw"></i> Logout
							</a>
						</div>
					</li></ul>
			</div>
		</nav>
	</div>
	<div id="page-inner">
		<div class="row">
			<div class="col-md-8">
				<div class="card">
					<div class="card-action">
						Introduction
					</div>
					<div class="card-action">
						<div class="card-content">
								<div class="container" id="main" style="width: 800px; height:600px;"></div>

						</div>
					</div>
				</div>
			</div>
				<div class="col-md-4">
					<!-- Advanced Tables -->
					<div class="card">
						<div class="card-action">
							Predict Table
						</div>
						<div class="card-content">
							<div class="table-responsive">
								<table class="table table-condensed"
									   id="table"
									   data-toggle="table"
									   data-toolbar="#toolbar">
									<thead class="thead-light">
									<tr>
										<th data-field="id">ID</th>
										<th data-field="name">Item Name</th>
										<th data-field="data">data</th>
										<th data-field="data1">data1</th>
									</tr>
									</thead>
								</table>

								<script src="https://unpkg.com/bootstrap-table@1.13.4/dist/bootstrap-table.min.js"></script>
								<script>
									function randomData() {
										var startId = ~~(Math.random() * 100);
										var rows = [];
										for (var i = 0; i < 10; i++) {
											rows.push({
												id: startId + i,
												name: 'test' + (startId + i),
												data:   startId + i,
												data1:  (startId + i)
											})
										}
										console.log(rows);
										return rows;
									}


									$(function() {
										$('#table').bootstrapTable('append',randomData());
										$("td,th").addClass("text-center");
									})
								</script>
							</div>

						</div>
					</div>
					<!--End Advanced Tables -->
				</div>
		</div>
	</div>


	</body>

	<script>
		var myChart = echarts.init(document.getElementById('main'));
		
		$(document).ready(function(){
			const url = "/api/history";
			// ajax异步请求
			// 待修改：symbol 需要输入/选择
			$.get(url, {"symbol": "IBM"}, function(res, status){

				var data = []
				for(var i in res){
					data.unshift([
						res[i].date,
						res[i].open,
						res[i].close,
						res[i].low,
						res[i].high,
						res[i].volume
					])
				}
				
				var data0 = splitData(data);
				console.log(data0)
				
				var option = {
					tooltip: {
						trigger: 'axis',
						axisPointer: {
							type: 'cross'
						}
					},
					grid: [{
						left: '3%',
						top: '1%',
						height: '58%'
					}, {
						left: '3%',
						right: '10%',
						top: '65%',
						height: '10%'
					}, {
						left: '3%',
						right: '10%',
						top: '78%',
						height: '10%'
					}],
					xAxis: [{
						type: 'category',
						data: data0.categoryData,
						scale: true,
						boundaryGap: false,
						axisLine: {
							onZero: false,
							lineStyle: {
								color: 'red',
							}
						},
						splitLine: {
							show: false
						},
						splitNumber: 20
					}, {
						type: 'category',
						gridIndex: 1,
						data: data0.categoryData,
						axisLabel: {
							show: false
						},
				
					}, {
						type: 'category',
						gridIndex: 2,
						data: data0.categoryData,
						axisLabel: {
							show: false
						},
				
					}],
					yAxis: [{
						scale: true,
						splitArea: {
							show: true
						},
						axisLine: {
							lineStyle: {
								color: 'red',
							}
						},
						position: 'right'
					}, {
						gridIndex: 1,
						splitNumber: 3,
						axisLine: {
							onZero: false,
							lineStyle: {
								color: 'red'
				
							}
						},
						axisTick: {
							show: false
						},
						splitLine: {
							show: false
						},
						axisLabel: {
							show: true
						},
						position: 'right'
					}, {
						gridIndex: 2,
						splitNumber: 4,
						axisLine: {
							onZero: false,
							lineStyle: {
								color: 'red'
				
							}
						},
						axisTick: {
							show: false
						},
						splitLine: {
							show: false
						},
						axisLabel: {
							show: true
						},
						position: 'right'
					}],
					dataZoom: [{
						type: 'inside',
						start: 100,
						end: 80
					}, {
						show: true,
						type: 'slider',
						y: '90%',
						xAxisIndex: [0, 1],
						start: 50,
						end: 100
					}, {
						show: false,
						xAxisIndex: [0, 2],
						type: 'slider',
						start: 20,
						end: 100
					}],
					series: [{
						name: 'value',
						type: 'candlestick',
						data: data0.values,
						markPoint: {
							data: [{
								name: 'XX标点'
							}]
						},
						markLine: {
							silent: true,
							data: [{
								yAxis: 2222,
							}]
						}
					}, {
						name: 'MA5',
						type: 'line',
						data: calculateMA(5, data0),
						smooth: true,
						lineStyle: {
							normal: {
								opacity: 0.5
							}
						}
					}, {
						name: 'MA10',
						type: 'line',
						data: calculateMA(10, data0),
						smooth: true,
						lineStyle: {
							normal: {
								opacity: 0.5
							}
						}
					}, {
						name: 'MA20',
						type: 'line',
						data: calculateMA(20, data0),
						smooth: true,
						lineStyle: {
							normal: {
								opacity: 0.5
							}
						}
					}, {
						name: 'MA30',
						type: 'line',
						data: calculateMA(30, data0),
						smooth: true,
						lineStyle: {
							normal: {
								opacity: 0.5
							}
						}
					}, {
						name: 'Volumn',
						type: 'bar',
						xAxisIndex: 1,
						yAxisIndex: 1,
						data: data0.vols,
						itemStyle: {
							normal: {
								color: function(params) {
									var colorList;
									if (data0.values[params.dataIndex][1] > data0.values[params.dataIndex][0]) {
										colorList = '#ef232a';
									} else {
										colorList = '#14b143';
									}
									return colorList;
								},
							}
						}
					}, {
						name: 'MACD',
						type: 'bar',
						xAxisIndex: 2,
						yAxisIndex: 2,
						data: data0.macds,
						itemStyle: {
							normal: {
								color: function(params) {
									var colorList;
									if (params.data >= 0) {
										colorList = '#ef232a';
									} else {
										colorList = '#14b143';
									}
									return colorList;
								},
							}
						}
					}, {
						name: 'DIF',
						type: 'line',
						xAxisIndex: 2,
						yAxisIndex: 2,
						data: data0.difs
					}, {
						name: 'DEA',
						type: 'line',
						xAxisIndex: 2,
						yAxisIndex: 2,
						data: data0.deas
					}]
				};
				

				
				myChart.setOption(option);
			});
		});
		
		function calculateMA(dayCount, data0) {
			var result = [];
			len = data0.values.length;
			for (var i = 0; i < len; i++) {
				if (i < dayCount) {
					result.push('-');
					continue;
				}
				var sum = 0;
				for (var j = 0; j < dayCount; j++) {
					sum += data0.values[i - j][1];
				}
				
				result.push(sum / dayCount);
				
			}
		
			return result;
		}
		
		function splitData(rawData) {
			var categoryData = [];
			var values = [];
			var vols = [];
			var macds = [];
			var difs = [];
			var deas = [];
			for (var i = 0; i < rawData.length; i++) {
				categoryData.push(rawData[i].splice(0, 1)[0]);
				values.push(rawData[i])
				vols.push(rawData[i][4]);
				macds.push(rawData[i][6]);
				difs.push(rawData[i][7]);
				deas.push(rawData[i][8]);
			}
			return {
				categoryData: categoryData,
				values: values,
				vols: vols,
				macds: macds,
				difs: difs,
				deas: deas
			};
		}
		

	</script>
</html>
